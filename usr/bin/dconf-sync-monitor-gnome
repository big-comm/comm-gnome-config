#!/bin/bash

# dconf-sync-monitor-gnome - Monitor and sync dconf settings for GNOME
# Part of comm-gnome-config package

set -euo pipefail

DESKTOP_ENV="gnome"
DCONF_DIR="${HOME}/.config/dconf"
SETTINGS_FILE="${DCONF_DIR}/settings.${DESKTOP_ENV}"
LOG_FILE="/tmp/dconf-sync-${DESKTOP_ENV}.log"

# Ensure directory exists
mkdir -p "${DCONF_DIR}"

# Logging function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [${DESKTOP_ENV}] $1" | tee -a "${LOG_FILE}"
}

# Check if dconf has valid settings (not reset to defaults)
is_dconf_valid() {
    local icon_theme=$(dconf read /org/gnome/desktop/interface/icon-theme 2>/dev/null || echo "")
    # If icon-theme is empty, 'default', or 'HighContrast', dconf may be in a reset state
    if [[ -z "$icon_theme" || "$icon_theme" == "'default'" || "$icon_theme" == "'HighContrast'" ]]; then
        return 1
    fi
    return 0
}

# Debounce mechanism - avoid saving too frequently
LAST_SAVE=0
DEBOUNCE_SECONDS=2

save_settings() {
    local current_time=$(date +%s)
    local time_diff=$((current_time - LAST_SAVE))

    if [ ${time_diff} -lt ${DEBOUNCE_SECONDS} ]; then
        return
    fi

    # Verify dconf has valid settings before saving
    if ! is_dconf_valid; then
        local current_icon=$(dconf read /org/gnome/desktop/interface/icon-theme 2>/dev/null || echo "empty")
        log_message "Skipping save - dconf appears reset (icon-theme: $current_icon)"
        return
    fi

    log_message "Saving dconf settings to ${SETTINGS_FILE}"

    # Atomic write using temp file
    if dconf dump / > "${SETTINGS_FILE}.tmp" 2>/dev/null; then
        mv "${SETTINGS_FILE}.tmp" "${SETTINGS_FILE}"
        LAST_SAVE=${current_time}
        log_message "Settings saved successfully"
    else
        log_message "ERROR: Failed to dump dconf settings"
        rm -f "${SETTINGS_FILE}.tmp"
    fi
}

# Main monitoring loop
log_message "Starting dconf monitor for ${DESKTOP_ENV}"
log_message "Settings file: ${SETTINGS_FILE}"

# Wait a moment for GNOME Shell to fully initialize before any saves
sleep 3

# Check initial state
if is_dconf_valid; then
    log_message "Initial dconf state is valid, saving..."
    save_settings
else
    current_icon=$(dconf read /org/gnome/desktop/interface/icon-theme 2>/dev/null || echo "empty")
    log_message "Initial dconf state appears reset (icon-theme: $current_icon), skipping initial save"
fi

# Monitor dconf changes
log_message "Monitoring dconf changes..."
dconf watch / | while read -r change; do
    log_message "Change detected: ${change}"
    save_settings
done

log_message "Monitor stopped"
