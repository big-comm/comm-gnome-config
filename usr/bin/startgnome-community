#!/bin/sh
#===============================================================================
# Script Name: startgnome-community
# Description: GNOME Desktop Session Initialization for BigLinux Community
#              Configures environment variables, GPU settings, theme sync,
#              and dconf/mimeapps management for multi-desktop switching.
# Package:     comm-gnome-config
#
# Dependencies:
#   - dconf (settings storage)
#   - gsettings (GNOME settings)
#   - systemctl (service management)
#   - kvantum (Qt theming)
#===============================================================================

#-------------------------------------------------------------------------------
# NVIDIA GPU Detection and Workarounds
# Forces OpenGL renderer and disables Vulkan for compatibility
#-------------------------------------------------------------------------------
lspci | grep -qi "vga.*nvidia" && {
    export GSK_RENDERER=gl
    export GDK_DISABLE=vulkan
    export GDK_GL_DISABLE=buffer-storage
}

#-------------------------------------------------------------------------------
# Qt Application Theming
#-------------------------------------------------------------------------------
[[ -z $QT_STYLE_OVERRIDE ]] && export QT_STYLE_OVERRIDE="kvantum"
[[ -z $QT_QPA_PLATFORMTHEME ]] && export QT_QPA_PLATFORMTHEME="gnome"
[[ -z $QT_WAYLAND_DECORATION ]] && export QT_WAYLAND_DECORATION="adwaita"

# Enable Wayland for Electron apps
[[ -z $ELECTRON_OZONE_PLATFORM_HINT ]] && export ELECTRON_OZONE_PLATFORM_HINT="auto"

#-------------------------------------------------------------------------------
# Sync Qt Theme with GNOME (Dark/Light Mode)
#-------------------------------------------------------------------------------
if [[ -f /usr/share/sync-kde-and-gtk-places/sync-gnome-theme-to-qt.sh ]]; then
    # Retry up to 3 times with 0.7s interval
    for i in {1..3}; do
        if /usr/share/sync-kde-and-gtk-places/sync-gnome-theme-to-qt.sh; then
            logger "sync-gnome-theme-to-qt.sh executed successfully"
            break
        else
            logger "Failed to execute sync-gnome-theme-to-qt.sh, attempt $i"
            sleep 0.7
        fi
    done
else
    logger "sync-gnome-theme-to-qt.sh not found"
fi

#-------------------------------------------------------------------------------
# GTK Renderer Selection
# Use cairo for mesa-amber or virtual machines for stability
#-------------------------------------------------------------------------------
if compgen -G /var/lib/pacman/local/mesa-amber-* || systemd-detect-virt -q; then
    [[ -z $GSK_RENDERER ]] && export GSK_RENDERER="cairo"
else
    [[ -z $GSK_RENDERER ]] && export GSK_RENDERER="gl"
fi

# Ensure LANGUAGE is set
if [[ -z "$LANGUAGE" ]]; then
    [[ -z $LANGUAGE ]] && export LANGUAGE=$LANG
fi

#-------------------------------------------------------------------------------
# First Login: Default Shell Configuration
#-------------------------------------------------------------------------------
if [[ ! -f "$HOME/.biglinux-shell-changed" ]]; then
    biglinux-change-default-shell bash-power
    touch "$HOME/.biglinux-shell-changed"
fi

#-------------------------------------------------------------------------------
# OBS Studio Vulkan Game Capture Support
#-------------------------------------------------------------------------------
if [[ -e /usr/bin/obs-vkcapture ]]; then
    [[ -z $OBS_USE_EGL ]] && export OBS_USE_EGL=1
    [[ -z $OBS_VKCAPTURE ]] && export OBS_VKCAPTURE=1
    [[ -z $VK_INSTANCE_LAYERS ]] && export VK_INSTANCE_LAYERS="VK_LAYER_OBS_vkcapture_64:VK_LAYER_VALVE_steam_overlay_64"
fi

#-------------------------------------------------------------------------------
# Keyboard LED Control
#-------------------------------------------------------------------------------
if [[ -e "$HOME/.config/ledkeyboard" ]]; then
    change-keyboard-led on
fi

#-------------------------------------------------------------------------------
# Cursor Theme Check
#-------------------------------------------------------------------------------
dconfPath=/org/gnome/desktop/interface/cursor-theme
currentTheme=$(dconf read $dconfPath)

# Enable automatic device mounting
gsettings set org.gnome.desktop.media-handling automount true


#-------------------------------------------------------------------------------
# DConf and MimeApps Multi-Desktop Switching Support
# Allows users to switch between GNOME, Cinnamon, and XFCE while preserving
# desktop-specific settings for each environment.
#-------------------------------------------------------------------------------
dconf_dir="$HOME/.config/dconf"
mimeapps_dir="$HOME/.config"
log_file="/tmp/dconf-switch-gnome.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [GNOME] $1" | tee -a "$log_file"
}

load_mimeapps_config() {
    log_message "Loading GNOME mimeapps configuration"
    if [[ -f "$mimeapps_dir/gnome.mimeapps.list" ]]; then
        log_message "Found existing GNOME mimeapps, loading..."
        cp "$mimeapps_dir/gnome.mimeapps.list" "$mimeapps_dir/mimeapps.list"
    else
        log_message "No existing GNOME mimeapps found, creating empty file"
        touch "$mimeapps_dir/mimeapps.list"
    fi
}

# Function to save mimeapps configuration
save_mimeapps_config() {
    if [ -f "$mimeapps_dir/mimeapps.list" ]; then
        log_message "Saving GNOME mimeapps configuration"
        cp "$mimeapps_dir/mimeapps.list" "$mimeapps_dir/gnome.mimeapps.list.tmp" && \
        mv "$mimeapps_dir/gnome.mimeapps.list.tmp" "$mimeapps_dir/gnome.mimeapps.list"
    fi
}

# Function to load dconf configuration
load_dconf_config() {
    mkdir -p "$dconf_dir"
    log_message "Loading GNOME dconf configuration"
    log_message "XDG_CURRENT_DESKTOP: $XDG_CURRENT_DESKTOP"

    if [[ -f "$dconf_dir/settings.gnome" ]]; then
        log_message "Found existing GNOME settings, loading..."
        log_message "Resetting dconf database"
        dconf reset -f /

        log_message "Loading settings from: $dconf_dir/settings.gnome"
        if dconf load / < "$dconf_dir/settings.gnome"; then
            log_message "GNOME settings loaded successfully"
        else
            log_message "ERROR: Failed to load GNOME settings"
        fi
    else
        log_message "No existing GNOME settings found - will create on first save"
    fi
}

start_sync_services() {
    log_message "Starting sync services..."

    # DConf sync service
    log_message "Starting dconf-sync-gnome.service"
    if systemctl --user enable dconf-sync-gnome.service 2>/dev/null; then
        log_message "dconf-sync service enabled"
    fi
    if systemctl --user restart dconf-sync-gnome.service 2>/dev/null; then
        log_message "dconf-sync service started successfully"
    else
        log_message "WARNING: Failed to start dconf-sync service"
    fi

    # MimeApps sync service
    log_message "Starting mimeapps-sync-gnome.service"
    if systemctl --user enable mimeapps-sync-gnome.service 2>/dev/null; then
        log_message "mimeapps-sync service enabled"
    fi
    if systemctl --user restart mimeapps-sync-gnome.service 2>/dev/null; then
        log_message "mimeapps-sync service started successfully"
    else
        log_message "WARNING: Failed to start mimeapps-sync service"
    fi
}

log_message "=========================================="
log_message "Starting GNOME session configuration"
log_message "=========================================="

load_mimeapps_config
load_dconf_config
start_sync_services

log_message "GNOME session configuration completed"


#-------------------------------------------------------------------------------
# LiveCD-Specific Configuration
#-------------------------------------------------------------------------------
if [[ -e /usr/bin/startbiglive ]]; then
    # Set GNOME environment variables
    export DESKTOP_SESSION=gnome
    export XDG_SESSION_DESKTOP=gnome
    export XDG_CURRENT_DESKTOP=GNOME
    export GDMSESSION=gnome

    # Enable basic password storage in Chromium browsers (no encrypted keyring in live mode)
    sudo sed -i '/--password-store=basic/!s/\(exec \/usr\/lib\/brave-browser\/brave "$@" $USER_FLAGS\)$/\1 --password-store=basic/' /usr/bin/brave

    # Clean up empty placeholder files
    rm -f "$HOME/Empty Bash" "$HOME/Empty Desktop File.desktop" "$HOME/Empty File"

    # Create user directories for current locale
    LANG=$LANG xdg-user-dirs-update --force
fi
