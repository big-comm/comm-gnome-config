#!/bin/bash
#===============================================================================
# Script Name: dconf-sync-stop-gnome
# Description: dconf Sync Service Stop Handler for GNOME
#              Performs final settings save before service shutdown.
# Package:     comm-gnome-config
#===============================================================================

set -euo pipefail

DESKTOP_ENV="gnome"
DCONF_DIR="$HOME/.config/dconf"
SETTINGS_FILE="$DCONF_DIR/settings.$DESKTOP_ENV"
LOG_FILE="/tmp/dconf-sync-$DESKTOP_ENV.log"

#-------------------------------------------------------------------------------
# Logging Function
#-------------------------------------------------------------------------------
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$DESKTOP_ENV] $1" | tee -a "$LOG_FILE"
}

log_message "Stopping dconf sync - performing final save"

# Ensure directory exists
mkdir -p "$DCONF_DIR"

#-------------------------------------------------------------------------------
# Final Save with Retry Logic
#-------------------------------------------------------------------------------
for attempt in {1..3}; do
    if dconf dump / > "$SETTINGS_FILE.tmp" 2>/dev/null; then
        mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
        log_message "Final settings saved successfully (attempt $attempt)"
        exit 0
    else
        log_message "WARNING: Failed to save settings (attempt $attempt/3)"
        sleep 0.5
    fi
done

log_message "ERROR: Failed to save final settings after 3 attempts"
rm -f "$SETTINGS_FILE.tmp"
exit 1
