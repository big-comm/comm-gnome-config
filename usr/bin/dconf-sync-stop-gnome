#!/bin/bash

# dconf-sync-stop-gnome - Final save when stopping dconf sync service for GNOME
# Part of comm-gnome-config package

set -euo pipefail

DESKTOP_ENV="gnome"
DCONF_DIR="${HOME}/.config/dconf"
SETTINGS_FILE="${DCONF_DIR}/settings.${DESKTOP_ENV}"
LOG_FILE="/tmp/dconf-sync-${DESKTOP_ENV}.log"

# Logging function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [${DESKTOP_ENV}] $1" | tee -a "${LOG_FILE}"
}

log_message "Stopping dconf sync service"

# Check if dconf is still responsive and has valid settings
# During session shutdown, dconf may already be reset to defaults
current_icon_theme=$(dconf read /org/gnome/desktop/interface/icon-theme 2>/dev/null || echo "")

# If icon-theme is empty, 'default', or 'HighContrast', the session is likely shutting down
# and dconf has been reset - don't overwrite the saved file with empty/default values
if [[ -z "$current_icon_theme" || "$current_icon_theme" == "'default'" || "$current_icon_theme" == "'HighContrast'" ]]; then
    log_message "Skipping final save - dconf appears to be reset (icon-theme: ${current_icon_theme:-empty})"
    log_message "Keeping previously saved settings intact"
    exit 0
fi

log_message "Performing final save (icon-theme: $current_icon_theme)"

# Ensure directory exists
mkdir -p "${DCONF_DIR}"

# Final save with retry logic
for attempt in {1..3}; do
    if dconf dump / > "${SETTINGS_FILE}.tmp" 2>/dev/null; then
        mv "${SETTINGS_FILE}.tmp" "${SETTINGS_FILE}"
        log_message "Final settings saved successfully (attempt ${attempt})"
        exit 0
    else
        log_message "WARNING: Failed to save settings (attempt ${attempt}/3)"
        sleep 0.5
    fi
done

log_message "ERROR: Failed to save final settings after 3 attempts"
rm -f "${SETTINGS_FILE}.tmp"
exit 1
